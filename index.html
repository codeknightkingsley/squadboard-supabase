<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SquadBoard | Connected</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
        }
        header {
            background: #161b22;
            padding: 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        h1 { font-size: 1.5rem; }
        .connection-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: #238636;
        }
        .connection-status.offline {
            background: #da3633;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover { background: #2ea043; }
        button:disabled {
            background: #30363d;
            cursor: not-allowed;
        }
        
        /* App Layout - Sidebar + Main Content */
        .app-layout {
            display: flex;
            min-height: calc(100vh - 61px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 220px;
            background: #161b22;
            border-right: 1px solid #30363d;
            padding: 16px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s ease;
            overflow: hidden;
        }
        .sidebar.collapsed {
            width: 60px;
            padding: 16px 8px;
        }
        .sidebar.collapsed .agent-name,
        .sidebar.collapsed .agent-role,
        .sidebar.collapsed .global-rules,
        .sidebar.collapsed .activity-feed,
        .sidebar.collapsed .sidebar-header h3 {
            display: none;
        }
        .sidebar.collapsed .sidebar-header {
            justify-content: center;
        }
        .sidebar.collapsed .agent-card {
            padding: 10px;
            justify-content: center;
        }
        .sidebar.collapsed .agent-header {
            justify-content: center;
        }
        .sidebar.collapsed .status-indicator {
            display: none;
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }
        .sidebar-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #e6edf3;
            margin: 0;
        }
        .sidebar-toggle {
            background: #21262d;
            border: 1px solid #30363d;
            color: #7d8590;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .sidebar-toggle:hover {
            background: #30363d;
            color: #e6edf3;
        }
        
        .agent-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }
        
        /* Agent Cards - Vertical Layout */
        .agent-card {
            background: #21262d;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .agent-card:hover {
            border-color: #58a6ff;
            background: #262c36;
        }
        .agent-card.selected {
            border-color: #58a6ff;
            background: #58a6ff20;
        }
        .agent-card.active {
            border-color: #238636;
            background: #23863620;
        }
        .agent-card.focus {
            border-color: #f0883e;
            background: #f0883e20;
        }
        .agent-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            font-size: 0.6rem;
            line-height: 1;
        }
        .status-indicator.active { color: #238636; }
        .status-indicator.standby { color: #7d8590; }
        .status-indicator.focus { color: #f0883e; }
        .agent-emoji {
            font-size: 1.2rem;
        }
        .agent-name {
            font-weight: 600;
            font-size: 0.85rem;
            flex: 1;
        }
        .agent-role {
            font-size: 0.7rem;
            color: #7d8590;
            margin-left: 22px;
        }
        
        /* Global Rules */
        .global-rules {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid #30363d;
        }
        .global-rules h4 {
            font-size: 0.8rem;
            color: #7d8590;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .global-rules ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .global-rules li {
            font-size: 0.7rem;
            color: #7d8590;
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Activity Feed */
        .activity-feed {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #30363d;
        }
        .activity-feed h4 {
            font-size: 0.85rem;
            color: #7d8590;
            margin-bottom: 12px;
        }
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .activity-item {
            font-size: 0.75rem;
            color: #e6edf3;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .activity-time {
            color: #7d8590;
            margin-left: auto;
        }
        .activity-empty {
            font-size: 0.75rem;
            color: #7d8590;
            font-style: italic;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow-x: auto;
            display: flex;
            flex-direction: column;
        }
        .main-content .loading,
        .main-content .error {
            margin: 20px;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
            flex: 1;
        }
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100% !important;
                flex-direction: row;
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid #30363d;
                min-height: auto;
            }
            .sidebar.collapsed {
                width: 100% !important;
            }
            .sidebar-header {
                display: none;
            }
            .agent-list {
                flex-direction: row;
                overflow-x: auto;
                gap: 10px;
            }
            .agent-card {
                min-width: 100px;
                flex-shrink: 0;
            }
            .global-rules {
                display: none;
            }
            .board {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }
            header {
                flex-direction: column;
                text-align: center;
            }
        }
        .column {
            background: #161b22;
            border-radius: 12px;
            border: 1px solid #30363d;
            min-height: 400px;
        }
        .column h2 {
            padding: 15px;
            font-size: 1rem;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
        }
        .count {
            background: #30363d;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        .task-container {
            padding: 10px;
            min-height: 300px;
        }
        .task-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .task-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }
        .task-card.selected {
            outline: 2px solid #58a6ff;
        }
        .task-card:hover .quick-actions-btn {
            opacity: 1;
        }
        .quick-actions-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #30363d;
            border: none;
            color: #7d8590;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quick-actions-btn:hover {
            background: #484f58;
            color: #e6edf3;
        }
        .quick-actions-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 1000;
            min-width: 150px;
            overflow: hidden;
        }
        .quick-actions-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 14px;
            background: none;
            border: none;
            color: #e6edf3;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .quick-actions-menu button:hover {
            background: #30363d;
        }
        .quick-actions-menu .submenu {
            position: relative;
        }
        .quick-actions-menu .submenu-items {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            min-width: 140px;
        }
        .quick-actions-menu .submenu:hover .submenu-items {
            display: block;
        }
        .quick-actions-menu .danger {
            color: #f85149;
        }
        .task-card.processing {
            opacity: 0.6;
            pointer-events: none;
        }
        .task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .task-container.drag-over {
            background: rgba(88, 166, 255, 0.1);
            border: 2px dashed #58a6ff;
            border-radius: 8px;
        }
        .task-assignee {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .priority-dot.high { background: #da3633; }
        .priority-dot.medium { background: #d29922; }
        .priority-dot.low { background: #238636; }
        .task-title {
            font-weight: 600;
            font-size: 0.95rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .task-meta {
            font-size: 0.75rem;
            color: #7d8590;
            margin-top: 6px;
            display: flex;
            gap: 10px;
        }
        .task-meta .overdue {
            color: #da3633;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #7d8590;
        }
        .error {
            background: #da3633;
            color: white;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7d8590;
            font-size: 0.9rem;
        }
        
        /* Task Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .modal-close {
            background: none;
            border: none;
            color: #7d8590;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            color: #e6edf3;
        }
        .modal-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            font-size: 0.85rem;
            color: #7d8590;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px 12px;
            color: #e6edf3;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #30363d;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-secondary {
            background: #30363d;
        }
        .btn-secondary:hover {
            background: #484f58;
        }
        .btn-danger {
            background: #da3633;
            margin-right: auto;
        }
        .btn-danger:hover {
            background: #f85149;
        }
        
        /* Comments Section */
        .comments-section {
            padding: 20px;
            border-top: 1px solid #30363d;
        }
        .comments-section h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: #e6edf3;
        }
        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }
        .comment-item {
            background: #21262d;
            border-radius: 8px;
            padding: 10px 12px;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .comment-author {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .comment-time {
            font-size: 0.75rem;
            color: #7d8590;
        }
        .comment-text {
            font-size: 0.85rem;
            color: #e6edf3;
        }
        .comment-input-wrapper {
            display: flex;
            gap: 10px;
        }
        .comment-input-wrapper textarea {
            flex: 1;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px;
            color: #e6edf3;
            font-family: inherit;
            resize: none;
        }
        .btn-comment {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        .comments-empty {
            color: #7d8590;
            font-size: 0.85rem;
            text-align: center;
            padding: 20px;
        }
        .meta-info {
            background: #21262d;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .meta-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #30363d;
        }
        .meta-row:last-child {
            border-bottom: none;
        }
        .meta-label {
            color: #7d8590;
            font-size: 0.85rem;
        }
        .meta-value {
            font-size: 0.85rem;
        }
        
        /* Search Input */
        .search-input {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e6edf3;
            font-size: 0.9rem;
            width: 200px;
        }
        .search-input:focus {
            outline: none;
            border-color: #58a6ff;
        }
        .search-input::placeholder {
            color: #7d8590;
        }
        
        /* Help Modal */
        .shortcuts-list {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.9rem;
        }
        .shortcuts-section {
            margin-bottom: 20px;
        }
        .shortcuts-section h3 {
            color: #7d8590;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        .shortcut-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #30363d;
        }
        .shortcut-row:last-child {
            border-bottom: none;
        }
        .shortcut-key {
            background: #30363d;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>ü¶û SquadBoard</h1>
        <input type="text" id="searchInput" placeholder="Search tasks... (/)" class="search-input">
        <span class="connection-status" id="connStatus">‚óè Connected</span>
        <button onclick="app.openCreateModal()" id="addBtn">+ New Task</button>
    </header>
    
    <div class="app-layout">
        <!-- Sidebar with Agents -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>üéØ Agents</h3>
                <button class="sidebar-toggle" onclick="app.toggleSidebar()">‚óÄ</button>
            </div>
            <div class="agent-list" id="agentPanel">
                <!-- Agents loaded dynamically -->
            </div>
            <div class="global-rules">
                <h4>üìú Global Rules</h4>
                <ul>
                    <li>‚ö° Write only if empty</li>
                    <li>‚ö° Never overwrite</li>
                    <li>‚ö° No external sends</li>
                    <li>‚ö° Time/budget caps</li>
                </ul>
            </div>
            <div class="activity-feed">
                <h4>üïí Activity</h4>
                <div class="activity-list" id="activityList">
                    <!-- Activity items here -->
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div id="loading" class="loading">Loading tasks from Supabase...</div>
            <div id="error" class="error" style="display:none;"></div>
            
            <div class="board" id="board" style="display:none;">
                <div class="column" data-status="backlog">
                    <h2>üìã To Do <span class="count" id="count-backlog">0</span></h2>
                    <div class="task-container" id="col-backlog"></div>
                </div>
                <div class="column" data-status="inprogress">
                    <h2>‚ö° In Progress <span class="count" id="count-inprogress">0</span></h2>
                    <div class="task-container" id="col-inprogress"></div>
                </div>
                <div class="column" data-status="inreview">
                    <h2>üëÄ In Review <span class="count" id="count-inreview">0</span></h2>
                    <div class="task-container" id="col-inreview"></div>
                </div>
                <div class="column" data-status="done">
                    <h2>‚úÖ Done <span class="count" id="count-done">0</span></h2>
                    <div class="task-container" id="col-done"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // SquadBoard connected to Supabase
        const CONFIG = {
            supabaseUrl: 'https://onyrtmjnktrqcwvmemlp.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ueXJ0bWpua3RycWN3dm1lbWxwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjE4MDY2MiwiZXhwIjoyMDgxNzU2NjYyfQ._jxNjivDzGsPJ-iNx5mNT5T9IC26LSLs_YgcI5Y0EDg',
            table: 'tasks'
        };
        
        const app = {
            tasks: [],
            agents: [],
            activities: [],
            refreshInterval: null,
            currentModal: null,
            selectedAgent: null,
            selectedTaskId: null,
            searchQuery: '',
            quickActionsMenu: null,
            
            async init() {
                try {
                    await Promise.all([
                        this.loadAgents(),
                        this.loadTasks()
                    ]);
                    this.renderAgents();
                    this.render();
                    this.setupDropZones();
                    this.setupKeyboardShortcuts();
                    this.setupSearchInput();
                    this.activities = JSON.parse(localStorage.getItem('squadboard-activities') || '[]');
                    this.renderActivityFeed();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('board').style.display = 'grid';
                    console.log('SquadBoard connected to Supabase');
                    
                    this.startRefreshInterval();
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            this.stopRefreshInterval();
                        } else {
                            this.startRefreshInterval();
                            this.loadTasks().then(() => this.render());
                        }
                    });
                    
                } catch (err) {
                    console.error('Failed to load:', err);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').textContent = 'Error: ' + err.message;
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('connStatus').textContent = '‚óè Offline';
                    document.getElementById('connStatus').classList.add('offline');
                }
            },
            
            async loadAgents() {
                // Hardcoded agents from controller_agents table
                this.agents = [
                    { id: 'steve', name: 'Steve', emoji: 'ü¶û', role: 'Controller', status: 'Active' },
                    { id: 'jarvis', name: 'Jarvis', emoji: 'ü§ñ', role: 'Assistant', status: 'Standby' },
                    { id: 'kodi', name: 'Kodi', emoji: 'üõ†Ô∏è', role: 'Developer', status: 'Standby' },
                    { id: 'scout', name: 'Scout', emoji: 'üî≠', role: 'Researcher', status: 'Standby' },
                    { id: 'teddy', name: 'Teddy', emoji: 'üìã', role: 'Writer', status: 'Standby' }
                ];
                
                // Load sidebar collapsed state from localStorage
                const collapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (collapsed) {
                    document.getElementById('sidebar').classList.add('collapsed');
                    document.querySelector('.sidebar-toggle').textContent = '‚ñ∂';
                }
            },
            
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const toggle = document.querySelector('.sidebar-toggle');
                const isCollapsed = sidebar.classList.toggle('collapsed');
                toggle.textContent = isCollapsed ? '‚ñ∂' : '‚óÄ';
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            },
            
            renderAgents() {
                const panel = document.getElementById('agentPanel');
                const statusSymbol = (status) => {
                    switch(status.toLowerCase()) {
                        case 'active': return '‚óè';
                        case 'focus': return '‚≠ò';
                        default: return '‚óã';
                    }
                };
                
                panel.innerHTML = this.agents.map(agent => `
                    <div class="agent-card ${agent.status.toLowerCase()} ${this.selectedAgent === agent.name ? 'selected' : ''}" 
                         onclick="app.selectAgent('${agent.name}')"
                         title="${agent.name} - ${agent.role} (${agent.status})">
                        <div class="agent-header">
                            <span class="status-indicator ${agent.status.toLowerCase()}">${statusSymbol(agent.status)}</span>
                            <span class="agent-emoji">${agent.emoji}</span>
                            <span class="agent-name">${agent.name}</span>
                        </div>
                        <div class="agent-role">${agent.role}</div>
                    </div>
                `).join('');
            },
            
            selectAgent(name) {
                this.selectedAgent = this.selectedAgent === name ? null : name;
                this.renderAgents();
                this.render();
            },
            
            setupDropZones() {
                const containers = document.querySelectorAll('.task-container');
                containers.forEach(container => {
                    container.addEventListener('dragover', (e) => this.handleDragOver(e));
                    container.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    container.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                    container.addEventListener('drop', (e) => this.handleDrop(e));
                });
            },
            
            setupSearchInput() {
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    this.render();
                });
            },
            
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    const activeEl = document.activeElement;
                    const isTyping = activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable;
                    
                    if (e.key === 'Escape') {
                        this.closeQuickActions();
                        if (this.currentModal) {
                            this.closeModal();
                        }
                        return;
                    }
                    
                    if (isTyping) return;
                    
                    switch (e.key) {
                        case 'n':
                            if (!this.currentModal) {
                                e.preventDefault();
                                this.openCreateModal();
                            }
                            break;
                        case '?':
                            e.preventDefault();
                            this.showKeyboardShortcutsHelp();
                            break;
                        case '/':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                        case 'j':
                        case 'ArrowDown':
                            if (!this.currentModal) {
                                e.preventDefault();
                                this.selectNextTask();
                            }
                            break;
                        case 'k':
                        case 'ArrowUp':
                            if (!this.currentModal) {
                                e.preventDefault();
                                this.selectPreviousTask();
                            }
                            break;
                        case 'Enter':
                            if (!this.currentModal && this.selectedTaskId) {
                                e.preventDefault();
                                const task = this.tasks.find(t => t.id === this.selectedTaskId);
                                if (task) this.openTaskModal(task);
                            }
                            break;
                        case '1':
                            if (!this.currentModal && this.selectedTaskId) {
                                e.preventDefault();
                                this.moveTask(this.selectedTaskId, 'todo', null);
                            }
                            break;
                        case '2':
                            if (!this.currentModal && this.selectedTaskId) {
                                e.preventDefault();
                                this.moveTask(this.selectedTaskId, 'in_progress', null);
                            }
                            break;
                        case '3':
                            if (!this.currentModal && this.selectedTaskId) {
                                e.preventDefault();
                                this.moveTask(this.selectedTaskId, 'in_progress', 'inreview');
                            }
                            break;
                        case '4':
                            if (!this.currentModal && this.selectedTaskId) {
                                e.preventDefault();
                                this.moveTask(this.selectedTaskId, 'archived', null);
                            }
                            break;
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (this.quickActionsMenu && !e.target.closest('.quick-actions-menu') && !e.target.closest('.quick-actions-btn')) {
                        this.closeQuickActions();
                    }
                });
            },
            
            getVisibleTasks() {
                let tasks = this.tasks;
                if (this.selectedAgent) {
                    tasks = tasks.filter(t => t.metadata?.assignee_name === this.selectedAgent);
                }
                if (this.searchQuery) {
                    tasks = tasks.filter(t => t.title.toLowerCase().includes(this.searchQuery));
                }
                return tasks;
            },
            
            selectNextTask() {
                const visibleTasks = this.getVisibleTasks();
                if (visibleTasks.length === 0) return;
                
                if (!this.selectedTaskId) {
                    this.selectedTaskId = visibleTasks[0].id;
                } else {
                    const currentIndex = visibleTasks.findIndex(t => t.id === this.selectedTaskId);
                    const nextIndex = (currentIndex + 1) % visibleTasks.length;
                    this.selectedTaskId = visibleTasks[nextIndex].id;
                }
                this.render();
                this.scrollToSelectedTask();
            },
            
            selectPreviousTask() {
                const visibleTasks = this.getVisibleTasks();
                if (visibleTasks.length === 0) return;
                
                if (!this.selectedTaskId) {
                    this.selectedTaskId = visibleTasks[visibleTasks.length - 1].id;
                } else {
                    const currentIndex = visibleTasks.findIndex(t => t.id === this.selectedTaskId);
                    const prevIndex = (currentIndex - 1 + visibleTasks.length) % visibleTasks.length;
                    this.selectedTaskId = visibleTasks[prevIndex].id;
                }
                this.render();
                this.scrollToSelectedTask();
            },
            
            scrollToSelectedTask() {
                const el = document.getElementById(`task-${this.selectedTaskId}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            },
            
            showKeyboardShortcutsHelp() {
                this.closeModal();
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <span class="modal-title">‚å®Ô∏è Keyboard Shortcuts</span>
                            <button class="modal-close" onclick="app.closeModal()">&times;</button>
                        </div>
                        <div class="modal-body shortcuts-list">
                            <div class="shortcuts-section">
                                <h3>General</h3>
                                <div class="shortcut-row">
                                    <span>New task</span>
                                    <span class="shortcut-key">n</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>Search</span>
                                    <span class="shortcut-key">/</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>Close modal</span>
                                    <span class="shortcut-key">Esc</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>This help</span>
                                    <span class="shortcut-key">?</span>
                                </div>
                            </div>
                            
                            <div class="shortcuts-section">
                                <h3>Navigation</h3>
                                <div class="shortcut-row">
                                    <span>Next task</span>
                                    <span class="shortcut-key">j / ‚Üì</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>Previous task</span>
                                    <span class="shortcut-key">k / ‚Üë</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>Open task</span>
                                    <span class="shortcut-key">Enter</span>
                                </div>
                            </div>
                            
                            <div class="shortcuts-section">
                                <h3>Move Task</h3>
                                <div class="shortcut-row">
                                    <span>To Do</span>
                                    <span class="shortcut-key">1</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>In Progress</span>
                                    <span class="shortcut-key">2</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>In Review</span>
                                    <span class="shortcut-key">3</span>
                                </div>
                                <div class="shortcut-row">
                                    <span>Done</span>
                                    <span class="shortcut-key">4</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeModal();
                };
                
                document.body.appendChild(modal);
                this.currentModal = modal;
            },
            
            showQuickActions(event, task) {
                event.stopPropagation();
                this.closeQuickActions();
                
                const btn = event.currentTarget;
                const card = btn.closest('.task-card');
                
                const menu = document.createElement('div');
                menu.className = 'quick-actions-menu';
                menu.innerHTML = `
                    <button onclick="app.openTaskModal(app.tasks.find(t => t.id === '${task.id}')); app.closeQuickActions();">
                        ‚úèÔ∏è Edit
                    </button>
                    <div class="submenu">
                        <button>üìÅ Move to ‚Üí</button>
                        <div class="submenu-items">
                            <button onclick="app.moveTask('${task.id}', 'todo', null); app.closeQuickActions();">üìã To Do</button>
                            <button onclick="app.moveTask('${task.id}', 'in_progress', null); app.closeQuickActions();">‚ö° In Progress</button>
                            <button onclick="app.moveTask('${task.id}', 'in_progress', 'inreview'); app.closeQuickActions();">üëÄ In Review</button>
                            <button onclick="app.moveTask('${task.id}', 'archived', null); app.closeQuickActions();">‚úÖ Done</button>
                        </div>
                    </div>
                    <button class="danger" onclick="app.deleteTaskQuick('${task.id}');">
                        üóëÔ∏è Delete
                    </button>
                `;
                
                card.appendChild(menu);
                this.quickActionsMenu = menu;
            },
            
            closeQuickActions() {
                if (this.quickActionsMenu) {
                    this.quickActionsMenu.remove();
                    this.quickActionsMenu = null;
                }
            },
            
            async deleteTaskQuick(taskId) {
                if (!confirm('Are you sure you want to delete this task?')) return;
                
                this.closeQuickActions();
                try {
                    await this.supabaseFetch(`${CONFIG.table}?id=eq.${taskId}`, {
                        method: 'DELETE'
                    });
                    await this.loadTasks();
                    this.render();
                } catch (err) {
                    alert('Failed to delete: ' + err.message);
                }
            },
            
            handleDragStart(e, taskId) {
                e.dataTransfer.setData('text/plain', taskId);
                e.dataTransfer.effectAllowed = 'move';
                e.target.classList.add('dragging');
            },
            
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                document.querySelectorAll('.task-container').forEach(c => c.classList.remove('drag-over'));
            },
            
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            },
            
            handleDragEnter(e) {
                e.preventDefault();
                const container = e.target.closest('.task-container');
                if (container) {
                    container.classList.add('drag-over');
                }
            },
            
            handleDragLeave(e) {
                const container = e.target.closest('.task-container');
                if (container && !container.contains(e.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            },
            
            async handleDrop(e) {
                e.preventDefault();
                const container = e.target.closest('.task-container');
                if (!container) return;
                
                container.classList.remove('drag-over');
                
                const taskId = e.dataTransfer.getData('text/plain');
                if (!taskId) return;
                
                const columnId = container.id.replace('col-', '');
                
                const columnToStatus = {
                    backlog: { status: 'todo', uiColumn: null },
                    inprogress: { status: 'in_progress', uiColumn: null },
                    inreview: { status: 'in_progress', uiColumn: 'inreview' },
                    done: { status: 'archived', uiColumn: null }
                };
                
                const mapping = columnToStatus[columnId];
                if (!mapping) return;
                
                const card = document.getElementById(`task-${taskId}`);
                if (card) {
                    card.classList.add('processing');
                    container.appendChild(card);
                }
                
                try {
                    await this.moveTask(taskId, mapping.status, mapping.uiColumn);
                } catch (err) {
                    console.error('Failed to move task:', err);
                    await this.loadTasks();
                    this.render();
                }
            },
            
            async moveTask(taskId, status, uiColumn) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                const updateData = { 
                    status,
                    metadata: { 
                        ...task.metadata,
                        uiColumn: uiColumn 
                    }
                };
                
                await this.supabaseFetch(`${CONFIG.table}?id=eq.${taskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });
                
                const columnName = this.formatStatus(status, uiColumn);
                const emoji = task.metadata?.emoji || 'üë§';
                this.logActivity('moved to ' + columnName, task.title, emoji);
                
                task.status = status;
                task.metadata = updateData.metadata;
                
                const card = document.getElementById(`task-${taskId}`);
                if (card) {
                    card.classList.remove('processing');
                }
                
                this.render();
            },
            
            startRefreshInterval() {
                if (!this.refreshInterval) {
                    this.refreshInterval = setInterval(() => {
                        this.loadTasks().then(() => this.render()).catch(console.error);
                    }, 10000);
                }
            },
            
            stopRefreshInterval() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            },
            
            async supabaseFetch(path, options = {}) {
                const url = `${CONFIG.supabaseUrl}/rest/v1/${path}`;
                const headers = {
                    'apikey': CONFIG.supabaseKey,
                    'Authorization': `Bearer ${CONFIG.supabaseKey}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                if (options.method === 'POST') {
                    headers['Prefer'] = 'return=representation';
                }
                
                const res = await fetch(url, { ...options, headers });
                if (!res.ok) {
                    const err = await res.text();
                    throw new Error(err);
                }
                if (res.status === 204) return null;
                return res.json();
            },
            
            async loadTasks() {
                this.tasks = await this.supabaseFetch(`${CONFIG.table}?order=created_at.desc`);
            },
            
            render() {
                const statusToColumn = {
                    todo: 'backlog',
                    in_progress: 'inprogress',
                    archived: 'done'
                };

                ['backlog', 'inprogress', 'inreview', 'done'].forEach(status => {
                    const col = document.getElementById(`col-${status}`);
                    if (col) col.innerHTML = '';
                    const countEl = document.getElementById(`count-${status}`);
                    if (countEl) countEl.textContent = '0';
                });

                const counts = { backlog: 0, inprogress: 0, inreview: 0, done: 0 };

                this.tasks.forEach(task => {
                    // Agent filter
                    const assigneeName = task.metadata?.assignee_name || task.assigned_to || 'Unassigned';
                    if (this.selectedAgent && assigneeName !== this.selectedAgent) {
                        return;
                    }
                    
                    // Search filter
                    if (this.searchQuery && !task.title.toLowerCase().includes(this.searchQuery)) {
                        return;
                    }
                    
                    let column;
                    if (task.metadata?.uiColumn === 'inreview') {
                        column = 'inreview';
                    } else {
                        column = statusToColumn[task.status] || 'backlog';
                    }

                    const emoji = task.metadata?.emoji || 'üë§';
                    const priority = task.priority || 'medium';
                    const dueDateHtml = this.formatDueDate(task.due_date);
                    const comments = task.metadata?.comments;
                    const commentHtml = comments && comments.length > 0 
                        ? `<span>üí¨ ${comments.length}</span>` 
                        : '';

                    const card = document.createElement('div');
                    card.className = 'task-card' + (task.id === this.selectedTaskId ? ' selected' : '');
                    card.id = `task-${task.id}`;
                    card.draggable = true;
                    card.dataset.taskId = task.id;
                    card.innerHTML = `
                        <button class="quick-actions-btn" onclick="event.stopPropagation(); app.showQuickActions(event, app.tasks.find(t => t.id === '${task.id}'))">‚ãÆ</button>
                        <div class="task-header">
                            <span class="task-assignee">${emoji}</span>
                            <span class="priority-dot ${priority}"></span>
                        </div>
                        <div class="task-title">${this.escapeHtml(task.title)}</div>
                        <div class="task-meta">
                            ${dueDateHtml}${commentHtml}
                        </div>
                    `;

                    card.addEventListener('dragstart', (e) => this.handleDragStart(e, task.id));
                    card.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    card.onclick = () => this.openTaskModal(task);

                    const col = document.getElementById(`col-${column}`);
                    if (col) {
                        col.appendChild(card);
                        counts[column]++;
                    }
                });

                ['backlog', 'inprogress', 'inreview', 'done'].forEach(status => {
                    const col = document.getElementById(`col-${status}`);
                    if (col && counts[status] === 0) {
                        col.innerHTML = '<div class="empty-state">No tasks</div>';
                    }
                    const el = document.getElementById(`count-${status}`);
                    if (el) el.textContent = counts[status];
                });
            },
            
            openTaskModal(task) {
                this.closeModal();
                
                const assigneeName = task.metadata?.assignee_name || task.assigned_to || 'Unassigned';
                const emoji = task.metadata?.emoji || 'üë§';
                const createdDate = task.created_at ? new Date(task.created_at).toLocaleString() : 'Unknown';
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : 'No due date';
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <span class="modal-title">${emoji} Task Details</span>
                            <button class="modal-close" onclick="app.closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="meta-info">
                                <div class="meta-row">
                                    <span class="meta-label">Created</span>
                                    <span class="meta-value">${createdDate}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Due Date</span>
                                    <span class="meta-value">${dueDate}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Current Status</span>
                                    <span class="meta-value">${this.formatStatus(task.status, task.metadata?.uiColumn)}</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-input" id="modalTitle" value="${this.escapeHtml(task.title)}">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="modalDescription" placeholder="Add a description...">${this.escapeHtml(task.description || '')}</textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Assigned To</label>
                                    <select class="form-select" id="modalAssignee">
                                        ${this.agents.map(a => `
                                            <option value="${a.name}" ${assigneeName === a.name ? 'selected' : ''}>
                                                ${a.emoji} ${a.name}
                                            </option>
                                        `).join('')}
                                        <option value="Unassigned" ${assigneeName === 'Unassigned' ? 'selected' : ''}>üë§ Unassigned</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="modalPriority">
                                        <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                                        <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                        <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Move To Status</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button onclick="app.moveTaskFromModal('${task.id}', 'todo', null)" class="btn-secondary">üìã To Do</button>
                                    <button onclick="app.moveTaskFromModal('${task.id}', 'in_progress', null)" class="btn-secondary">‚ö° In Progress</button>
                                    <button onclick="app.moveTaskFromModal('${task.id}', 'in_progress', 'inreview')" class="btn-secondary">üëÄ In Review</button>
                                    <button onclick="app.moveTaskFromModal('${task.id}', 'archived', null)" class="btn-secondary">‚úÖ Done</button>
                                </div>
                            </div>
                        </div>
                        <div class="comments-section">
                            <h4>üí¨ Comments</h4>
                            <div class="comments-list" id="commentsList">
                            </div>
                            <div class="comment-input-wrapper">
                                <textarea id="newComment" placeholder="Add a comment..." rows="2"></textarea>
                                <button onclick="app.addComment('${task.id}')" class="btn-comment">Post</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-danger" onclick="app.deleteTaskFromModal('${task.id}')">Delete</button>
                            <button class="btn-secondary" onclick="app.closeModal()">Cancel</button>
                            <button onclick="app.saveTaskFromModal('${task.id}')">Save Changes</button>
                        </div>
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeModal();
                };
                
                document.body.appendChild(modal);
                this.currentModal = modal;
                this.renderComments(task.id);
            },
            
            closeModal() {
                if (this.currentModal) {
                    this.currentModal.remove();
                    this.currentModal = null;
                }
            },
            
            formatStatus(status, uiColumn) {
                if (uiColumn === 'inreview') return 'In Review';
                const map = { todo: 'To Do', in_progress: 'In Progress', archived: 'Done' };
                return map[status] || status;
            },
            
            formatDueDate(dueDate) {
                if (!dueDate) return '';
                
                const due = new Date(dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                due.setHours(0, 0, 0, 0);
                
                const diffDays = Math.floor((due - today) / (1000 * 60 * 60 * 24));
                
                let label;
                let isOverdue = false;
                
                if (diffDays < 0) {
                    label = 'Overdue';
                    isOverdue = true;
                } else if (diffDays === 0) {
                    label = 'Today';
                } else if (diffDays === 1) {
                    label = 'Tomorrow';
                } else {
                    label = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                return `<span class="${isOverdue ? 'overdue' : ''}">üìÖ ${label}</span>`;
            },
            
            async saveTaskFromModal(taskId) {
                const title = document.getElementById('modalTitle').value.trim();
                const description = document.getElementById('modalDescription').value.trim();
                const assigneeName = document.getElementById('modalAssignee').value;
                const priority = document.getElementById('modalPriority').value;
                
                if (!title) {
                    alert('Title is required');
                    return;
                }
                
                const originalTask = this.tasks.find(t => t.id === taskId);
                const titleChanged = originalTask && originalTask.title !== title;
                
                try {
                    const agent = this.agents.find(a => a.name === assigneeName);
                    const emoji = agent ? agent.emoji : 'üë§';
                    
                    await this.supabaseFetch(`${CONFIG.table}?id=eq.${taskId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            title,
                            description: description || null,
                            priority,
                            metadata: { 
                                emoji, 
                                assignee_name: assigneeName,
                                uiColumn: this.tasks.find(t => t.id === taskId)?.metadata?.uiColumn
                            }
                        })
                    });
                    
                    if (titleChanged) {
                        this.logActivity('updated', title, emoji);
                    }
                    
                    this.closeModal();
                    await this.loadTasks();
                    this.render();
                } catch (err) {
                    alert('Failed to save: ' + err.message);
                }
            },
            
            async moveTaskFromModal(taskId, status, uiColumn) {
                try {
                    const updateData = { status };
                    if (uiColumn) {
                        updateData.metadata = { uiColumn };
                    }
                    
                    await this.supabaseFetch(`${CONFIG.table}?id=eq.${taskId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(updateData)
                    });
                    
                    this.closeModal();
                    await this.loadTasks();
                    this.render();
                } catch (err) {
                    alert('Failed to move: ' + err.message);
                }
            },
            
            async deleteTaskFromModal(taskId) {
                if (!confirm('Are you sure you want to delete this task?')) return;
                
                const task = this.tasks.find(t => t.id === taskId);
                const taskTitle = task ? task.title : 'Unknown';
                
                try {
                    await this.supabaseFetch(`${CONFIG.table}?id=eq.${taskId}`, {
                        method: 'DELETE'
                    });
                    this.logActivity('deleted', taskTitle, 'üóëÔ∏è');
                    this.closeModal();
                    await this.loadTasks();
                    this.render();
                } catch (err) {
                    alert('Failed to delete: ' + err.message);
                }
            },
            
            suggestAgent(text) {
                const lower = text.toLowerCase();
                if (/research|find|look\s*up/.test(lower)) return 'Scout';
                if (/build|fix|code|implement/.test(lower)) return 'Kodi';
                if (/draft|email|document/.test(lower)) return 'Teddy';
                return 'Steve';
            },
            
            openCreateModal() {
                this.closeModal();
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <span class="modal-title">‚ú® Create New Task</span>
                            <button class="modal-close" onclick="app.closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Title <span style="color: #da3633;">*</span></label>
                                <input type="text" class="form-input" id="createTitle" placeholder="Enter task title...">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="createDescription" placeholder="Add a description..."></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Assigned To</label>
                                    <select class="form-select" id="createAssignee">
                                        ${this.agents.map(a => `
                                            <option value="${a.name}" ${a.name === 'Steve' ? 'selected' : ''}>
                                                ${a.emoji} ${a.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="createPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="app.closeModal()">Cancel</button>
                            <button id="createSubmitBtn" onclick="app.createTask()" disabled>Create Task</button>
                        </div>
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeModal();
                };
                
                document.body.appendChild(modal);
                this.currentModal = modal;
                
                const titleInput = document.getElementById('createTitle');
                const submitBtn = document.getElementById('createSubmitBtn');
                const assigneeSelect = document.getElementById('createAssignee');
                
                titleInput.focus();
                
                titleInput.addEventListener('input', () => {
                    const hasTitle = titleInput.value.trim().length > 0;
                    submitBtn.disabled = !hasTitle;
                    
                    if (hasTitle) {
                        const suggested = this.suggestAgent(titleInput.value);
                        assigneeSelect.value = suggested;
                    }
                });
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    } else if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                        if (!submitBtn.disabled) {
                            this.createTask();
                        }
                    }
                });
            },
            
            async createTask() {
                const title = document.getElementById('createTitle').value.trim();
                const description = document.getElementById('createDescription').value.trim();
                const assigneeName = document.getElementById('createAssignee').value;
                const priority = document.getElementById('createPriority').value;
                
                if (!title) return;
                
                const agent = this.agents.find(a => a.name === assigneeName);
                const emoji = agent ? agent.emoji : 'üë§';

                try {
                    document.getElementById('createSubmitBtn').disabled = true;

                    await this.supabaseFetch(CONFIG.table, {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            description: description || null,
                            status: 'todo',
                            priority,
                            metadata: { emoji, assignee_name: assigneeName },
                            created_at: new Date().toISOString()
                        })
                    });

                    this.logActivity('created', title, emoji);
                    this.closeModal();
                    await this.loadTasks();
                    this.render();
                } catch (err) {
                    alert('Failed to create task: ' + err.message);
                    document.getElementById('createSubmitBtn').disabled = false;
                }
            },
            
            escapeHtml(text) {
                if (text == null) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            logActivity(action, taskTitle, agentEmoji) {
                const activity = {
                    emoji: agentEmoji,
                    action: action,
                    taskTitle: taskTitle,
                    time: Date.now()
                };
                this.activities.unshift(activity);
                if (this.activities.length > 20) this.activities.pop();
                this.renderActivityFeed();
                localStorage.setItem('squadboard-activities', JSON.stringify(this.activities));
            },
            
            renderActivityFeed() {
                const list = document.getElementById('activityList');
                if (!list) return;
                
                if (this.activities.length === 0) {
                    list.innerHTML = '<div class="activity-empty">No recent activity</div>';
                    return;
                }
                
                list.innerHTML = this.activities.map(a => `
                    <div class="activity-item">
                        <span class="activity-emoji">${a.emoji}</span>
                        <span class="activity-text">${a.action} "${this.escapeHtml(a.taskTitle)}"</span>
                        <span class="activity-time">${this.relativeTime(a.time)}</span>
                    </div>
                `).join('');
            },
            
            relativeTime(timestamp) {
                const diff = Date.now() - timestamp;
                const mins = Math.floor(diff / 60000);
                if (mins < 1) return 'just now';
                if (mins < 60) return mins + 'm ago';
                const hours = Math.floor(mins / 60);
                if (hours < 24) return hours + 'h ago';
                return Math.floor(hours / 24) + 'd ago';
            },
            
            renderComments(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                const list = document.getElementById('commentsList');
                if (!list || !task) return;
                
                const comments = task.metadata?.comments || [];
                
                if (comments.length === 0) {
                    list.innerHTML = '<div class="comments-empty">No comments yet</div>';
                    return;
                }
                
                list.innerHTML = comments.map(c => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">${c.emoji || 'üë§'} ${this.escapeHtml(c.author)}</span>
                            <span class="comment-time">${this.relativeTime(c.time)}</span>
                        </div>
                        <div class="comment-text">${this.escapeHtml(c.text)}</div>
                    </div>
                `).join('');
            },
            
            async addComment(taskId) {
                const input = document.getElementById('newComment');
                const text = input.value.trim();
                if (!text) return;
                
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                const comments = task.metadata?.comments || [];
                comments.push({
                    id: 'c' + Date.now(),
                    author: 'Steve',
                    emoji: 'ü¶û',
                    text: text,
                    time: Date.now()
                });
                
                try {
                    await this.supabaseFetch(`${CONFIG.table}?id=eq.${taskId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            metadata: { ...task.metadata, comments }
                        })
                    });
                    
                    input.value = '';
                    await this.loadTasks();
                    this.renderComments(taskId);
                    this.logActivity('commented on', task.title, 'üí¨');
                } catch (err) {
                    alert('Failed to add comment: ' + err.message);
                }
            }
        };
        
        app.init();
        
        window.addEventListener('beforeunload', () => {
            app.stopRefreshInterval();
        });
    </script>
</body>
</html>
